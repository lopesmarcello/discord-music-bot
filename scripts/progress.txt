# Ralph Progress Log
Started: Sat Feb 28 16:03:28 PST 2026
---

## Codebase Patterns
- Tests use `PYTHONPATH=/tmp/pypackages:/workspace /usr/bin/python3.11 -m pytest tests/ -x -q` (no pytest in PATH; packages in /tmp/pypackages)
- `tests/conftest.py` stubs `aiohttp`, `aiohttp.web`, and `jwt` so tests run without real packages installed
- `mock_web.middleware = lambda fn: fn` — aiohttp.web.middleware decorator must be a pass-through in the stub
- Music cog per-guild state uses `dict[int, T]` keyed by guild_id; same pattern for `_current_tracks`, `_voice_managers`, `_skipping`
- Skip race-condition guard: set `_skipping[guild_id] = True` BEFORE `vm.stop()`, clear AFTER `_play_next()` completes
- `_make_on_track_end` callback runs in discord.py audio thread — GIL protects dict reads/writes for the `_skipping` flag

---

## 2026-02-28 - US-001
- What was implemented: Added `_skipping: dict[int, bool]` flag to the `Music` cog to prevent the `on_track_end` callback from scheduling a second `_play_next` during an explicit skip, eliminating the double-`_play_next` race condition that caused the dashboard to reset to empty state.
- Files changed:
  - `bot/cogs/music.py`: Added `_skipping` attribute; guarded `_make_on_track_end` callback; set/clear flag in `Music.skip`
  - `bot/api/player.py`: Set/clear `_skipping` flag in `handle_queue_skip`
  - `bot/api/auth.py`: Staged pre-existing change (moved `@aiohttp.web.middleware` decorator outside inner function)
  - `tests/conftest.py`: Fixed `mock_web.middleware` to be a pass-through decorator (was MagicMock, broke auth tests)
  - `tests/integration/test_skip_command.py`: Added tests for flag initialization, flag cleared after skip, and callback no-op when skipping
  - `tests/test_player_api.py`: Added tests verifying flag is set before vm.stop() and cleared after _play_next
  - `scripts/prd.json`: Created from `tasks/prd-dashboard-reset-on-skip.md`
  - `tasks/prd-dashboard-reset-on-skip.md`: Added to repo
- **Learnings for future iterations:**
  - The `on_track_end` callback is registered via `vm.set_on_track_end(self._make_on_track_end(guild_id))` only during the Discord `/play` command (when joining voice channel). API-triggered plays do NOT register the callback — so for API-only guilds, `on_track_end` may never fire, and the `_skipping` flag guard in the callback is never invoked.
  - The `_skipping` reset after `_play_next` is a safety no-op in cases where the callback never fires (e.g., API-only flow).
  - The pre-existing `auth.py` change (adding `@aiohttp.web.middleware`) required a conftest stub fix — always check for pre-existing working-tree modifications before starting.
---
