## Codebase Patterns
- PlayerBar polls fetchPlayback + fetchQueue together via Promise.all every 5s; a separate setInterval ticks elapsedSeconds +1 per second when state is 'playing'
- Python tests use stubs in tests/conftest.py (aiohttp.web, jwt) — never need real aiohttp/PyJWT in tests
- pytest is not installed; use: PYTHONPATH=/tmp/pypackages:/workspace python3.11 -m pytest tests/ -v
  (first download pip: curl -sL https://bootstrap.pypa.io/pip/pip.pyz -o /tmp/pip.pyz && python3.11 /tmp/pip.pyz install pytest --target /tmp/pypackages)
- Bot guilds accessed via request.app["bot"].guilds; each guild has .id (int), .name (str), .icon (str|None)
- Elapsed time tracking: Music cog uses `_started_at: dict[int, float|None]` and `_elapsed_offset: dict[int, float]`; API handlers must update these when pausing/resuming/stopping (not just the cog commands)
- When changing API response shapes that TypeScript callers consume, always update both api.ts interfaces AND all .tsx components using them
- Guild IDs are integers on Discord objects but must be serialised as strings in JSON
- JWT middleware auto-protects all routes not starting with /auth/; new API routes are auto-protected
- TypeScript typecheck: cd /workspace/dashboard && npm run typecheck
- New API modules follow pattern: handle_X_get() function + setup_X_routes(app) function
- Design tokens defined in dashboard/src/index.css :root — use var(--token-name) in all components; token list: --bg-base, --bg-surface, --bg-elevated, --sidebar-bg, --player-bg, --border, --text-primary, --text-muted, --accent, --accent-hover
- React inline styles can reference CSS variables: style={{ background: 'var(--bg-base)' }}
- AppShell is the layout wrapper for all authenticated pages — import it in page components (not App.tsx); it provides the header, sidebar slot, main content area, and fixed playerBar slot
- AppShell grid: `gridTemplateColumns: sidebar ? 'auto 1fr' : '1fr'` — sidebar's own width (220/64px) drives the column width via `auto`
- DashboardPage fetches guilds list to resolve the current guild's name/icon (needed for header and Sidebar bottom section)

# Ralph Progress Log
Started: Sat Feb 28 16:27:50 PST 2026
---

## 2026-02-28 - US-001
- What was implemented: Added GET /api/guilds endpoint that returns guilds the bot is in
- Files changed:
  - bot/api/guilds.py (new): handle_guilds_get() and setup_guilds_routes()
  - bot/api/server.py: registered guilds routes via setup_guilds_routes()
  - dashboard/src/api.ts: added Guild interface and fetchGuilds() function
  - tests/test_guilds_api.py (new): 7 tests covering happy path, empty states, icon=None, string IDs
  - scripts/prd.json (new): created prd.json for new PRD
- **Learnings for future iterations:**
  - pytest is not installed; install to /tmp/pypackages and set PYTHONPATH (see Codebase Patterns above)
  - The mock_web.Response fake in conftest.py stores text as a string attribute; json.loads(resp.text) is the way to inspect responses
  - bot.guilds list has guild objects with .id (int), .name, .icon attributes; id must be str() in JSON
---

## 2026-02-28 - US-002
- What was implemented: Added `thumbnail: str` field to AudioTrack dataclass and surfaced it in all API responses
- Files changed:
  - bot/audio/resolver.py: added `thumbnail: str = ""` to AudioTrack dataclass; _make_track() now reads info.get("thumbnail", "")
  - bot/api/player.py: _track_dict() now includes "thumbnail" key
  - dashboard/src/api.ts: Track interface gains `thumbnail: string`
  - tests/unit/test_resolver.py: updated _youtube_info() helper to include thumbnail; added 5 new tests
  - tests/test_player_api.py: updated _make_track() helper to set track.thumbnail; fixed exact-equality assertion
- **Learnings for future iterations:**
  - AudioTrack dataclass uses default field values (thumbnail: str = "") — new optional fields can be added at end without breaking existing instantiations
  - _make_track() in test_player_api.py uses MagicMock; any attribute accessed in _track_dict() must be explicitly set or it returns an un-serialisable MagicMock
  - Exact dict equality assertions (assert data["x"] == {...}) must be updated when _track_dict() gains new keys
---

## 2026-02-28 - US-003
- What was implemented: Added `elapsed_seconds: float | None` to /api/playback response; Music cog tracks playback start time and accumulated offset
- Files changed:
  - bot/cogs/music.py: added `import time`, `_started_at` and `_elapsed_offset` dicts; updated `_play_next`, `pause`, `resume`, `stop` commands to maintain timing state
  - bot/api/player.py: `handle_playback_get` computes elapsed_seconds from cog timing; `handle_playback_pause/resume/stop` also update cog timing dicts
  - dashboard/src/api.ts: added `PlaybackData` interface; `fetchPlayback` now returns `Promise<PlaybackData>` with `{ state, elapsedSeconds }`
  - dashboard/src/components/PlaybackControls.tsx: updated `loadState` callback to extract `data.state` from new return type
  - tests/test_player_api.py: added `_started_at = {}` and `_elapsed_offset = {}` to `_make_music_cog`; updated existing playback tests; added 6 new tests for timing behaviour
- **Learnings for future iterations:**
  - Elapsed time uses two dicts: `_started_at` (unix timestamp of current play session start, None when paused/stopped) and `_elapsed_offset` (accumulated seconds from previous sessions)
  - Both the Discord cog commands AND the API handlers must update these timing dicts — the API handlers call vm methods directly, bypassing cog command methods
  - When API response shapes change (e.g. fetchPlayback now returns object not string), all TSX consumers must be updated too
  - `_make_music_cog()` in tests must explicitly initialise any dict attributes (`_started_at`, `_elapsed_offset`) the API handlers access; MagicMock auto-creates attributes that are un-serialisable
---

## 2026-02-28 - US-004
- What was implemented: Defined CSS design tokens as custom properties on :root in index.css; applied global resets and body styles; updated LoadingScreen to use tokens
- Files changed:
  - dashboard/src/index.css: replaced bare reset with full token palette on :root, global resets (box-sizing, margin, font-family), body background/color using tokens
  - dashboard/src/App.tsx: LoadingScreen now uses var(--bg-base) and var(--text-muted) instead of hardcoded hex values
  - scripts/prd.json: marked US-004 passes: true
- **Learnings for future iterations:**
  - Token names: --bg-base, --bg-surface, --bg-elevated, --sidebar-bg, --player-bg, --border, --text-primary, --text-muted, --accent (#e8620a), --accent-hover (#d4580a)
  - React inline styles accept CSS variable references as plain strings: style={{ color: 'var(--text-muted)' }}
  - Since body sets background/color globally, components don't need to repeat these — only override when needed
---

## 2026-02-28 - US-006
- What was implemented: Updated App.tsx to route authenticated users without a guild to GuildPickerPage instead of DashboardPage with "no guild" state
- Files changed:
  - dashboard/src/App.tsx: imported GuildPickerPage; added conditional branch — if guildId is undefined, render GuildPickerPage; otherwise render DashboardPage with the defined guildId
- **Learnings for future iterations:**
  - GuildPickerPage already accepted user and onLogout props, so no changes to GuildPickerPage were needed
  - The routing logic uses `guildId === undefined` (not a falsy check) to correctly narrow the type for DashboardPage's guildId prop
  - After this change, DashboardPage is never rendered with guildId=undefined; the "no guild" fallback in DashboardPage is now dead code (but left in place to avoid scope creep)
---

## 2026-02-28 - US-005
- What was implemented: Created GuildPickerPage component that fetches and displays a grid of guild cards
- Files changed:
  - dashboard/src/pages/GuildPickerPage.tsx (new): full GuildPickerPage with loading skeleton, empty state, error state, guild card grid, and GuildCard sub-component with hover accent
- **Learnings for future iterations:**
  - TypeScript ternary chains don't narrow union types — use explicit `=== null` checks instead of negation (`!guilds`) to ensure narrowing works in nested branches
  - Guild icon CDN URL pattern: `https://cdn.discordapp.com/icons/{guild.id}/{guild.icon}.png?size=64`
  - Navigation to guild: `window.location.href = '/?guild=...'` (not React Router, just direct URL change since guild selection changes the entire app state)
  - Loading skeleton uses same card dimensions as real cards but with opacity: 0.5 for the shimmer effect
---

## 2026-02-28 - US-008
- What was implemented: Created AppShell layout component; updated DashboardPage and GuildPickerPage to render inside it
- Files changed:
  - dashboard/src/components/AppShell.tsx (new): grid layout with optional sidebar slot, header (guild info left, user info right), scrollable main content, fixed playerBar slot
  - dashboard/src/pages/DashboardPage.tsx: removed own header; now renders inside AppShell with Sidebar as sidebar slot; fetches guild info via fetchGuilds() for header and Sidebar; manages activeView state to switch between Queue and Search
  - dashboard/src/pages/GuildPickerPage.tsx: removed own header; now renders inside AppShell (no sidebar, no playerBar); "Select a Server" title moved into main content area
  - scripts/prd.json: marked US-008 passes: true
- **Learnings for future iterations:**
  - AppShell uses CSS Grid `gridTemplateColumns: sidebar ? 'auto 1fr' : '1fr'` — the `auto` column tracks Sidebar's own 220/64px width
  - AppShell container uses `height: 100vh; overflow: hidden` with main content scrolling internally via `overflowY: auto` — this avoids double scrollbars
  - Main content area sets `paddingBottom: 96px` so content is not hidden by the fixed 80px player bar
  - DashboardPage fetches guilds and finds the current guild by ID to get guildName and guildIcon for AppShell header and Sidebar props
  - DashboardPage now manages SidebarView state and shows either Queue (PlaybackControls + QueueView) or Search (SearchBar) based on Sidebar navigation
  - void operator used on async handleLogout in onClick handler: `onClick={() => { void handleLogout(); }}` to satisfy TypeScript/ESLint
---

## 2026-02-28 - US-007
- What was implemented: Created collapsible Sidebar component with expanded (220px) and collapsed (64px) states, localStorage persistence, Queue/Search nav items, and guild info at bottom
- Files changed:
  - dashboard/src/components/Sidebar.tsx (new): full Sidebar with BotLogo, NavItem, HomeIcon, SearchIcon, ChevronLeft/Right SVG icons; localStorage-backed collapsed state
- **Learnings for future iterations:**
  - Sidebar exports `SidebarView = 'queue' | 'search'` type alongside the component — import both when wiring into DashboardPage/AppShell
  - NavItem uses `borderLeft: '3px solid var(--accent)'` for active state and `var(--bg-elevated)` background for both active and hover
  - localStorage collapse key: `sidebar_collapsed` — value is string `'true'` or `'false'`
  - SVG icons are defined as small local components (HomeIcon, SearchIcon, etc.) — no external icon library needed
  - `title` prop on NavItem button provides tooltip in collapsed mode for accessibility
---

## 2026-02-28 - US-009
- What was implemented: Created PlayerBar fixed bottom component with thumbnail, track info, playback controls, and progress bar; wired into DashboardPage via AppShell playerBar slot
- Files changed:
  - dashboard/src/components/PlayerBar.tsx (new): full PlayerBar with left (thumbnail + title/source), centre (Play/Pause, Skip, Stop buttons), right (elapsed/duration progress bar); polls every 5s; ticks elapsed every 1s when playing
  - dashboard/src/pages/DashboardPage.tsx: imports PlayerBar; passes it as playerBar prop to AppShell; wires onQueueChanged to increment queueRefreshKey
  - scripts/prd.json: marked US-009 passes: true
- **Learnings for future iterations:**
  - PlayerBar uses two useEffects: one for 5s API polling (depends on fetchData callback), one for 1s elapsed tick (depends on playbackState); both return cleanup clearInterval
  - `thumbnailUrl !== null` guard used (not just truthy) to satisfy TypeScript narrowing for the img src
  - controlButtonStyle is a const CSSProperties object — button state dimming is achieved via opacity on the parent container (isStopped ? 0.4 : 1) rather than per-button disabled styles
  - SVG icon components (PlayIcon, PauseIcon, SkipIcon, StopIcon) defined locally — no icon library needed
  - PlayerBar onQueueChanged callback triggers queueRefreshKey increment in DashboardPage so QueueView refreshes after skip/stop from the bar
---

## 2026-03-01 - US-010
- What was implemented: Redesigned QueueView component with Spotify-style track rows — index number, 40x40 thumbnail with letter placeholder fallback, title, duration, and skip icon inline for now-playing row
- Files changed:
  - dashboard/src/components/QueueView.tsx: added TrackThumbnail sub-component, refactored TrackRow to accept index/onSkip/busy props with hover outline state, replaced section-based layout with flat list, updated styles to use design tokens throughout
  - scripts/prd.json: marked US-010 passes: true
- **Learnings for future iterations:**
  - TrackRow uses `outline` (not border) for hover effect so it doesn't affect layout dimensions alongside the existing borderLeft
  - `index !== undefined ? index : null` pattern used to hide the index column for now-playing row (which shows skip icon instead)
  - Error state is unified with loading state: initial render shows "Loading queue…"; if error occurs after load, errorBanner shows inline above the list
---

## 2026-03-01 - US-011
- What was implemented: Redesigned SearchBar component — full-width input with orange focus ring, accent-coloured search button, result rows with 48x48 thumbnails and per-row Add button with loading/added states
- Files changed:
  - dashboard/src/components/SearchBar.tsx: added ResultThumbnail sub-component with letter placeholder fallback; per-row `added` Set state with 2s timer for "Added ✓" confirmation; updated all styles to use design tokens; input focused state via onFocus/onBlur + style spread
- **Learnings for future iterations:**
  - Per-item "added" confirmation state uses a Set + setTimeout; timers stored in a useRef<Map> to avoid stale closures; React 18 doesn't warn about state updates on unmounted components so cleanup is optional
  - Input focus ring achieved by tracking `focused` boolean in state and spreading `inputFocused` style (boxShadow + borderColor) onto the input — since inline styles can't use :focus pseudo-class
  - `addButtonAdding` (filled while in-flight) and `addButtonAdded` (filled with opacity after) are distinct style objects spread over the base `addButton` style via `{...styles.addButton, ...(condition ? styles.variant : {})}`
---

## 2026-03-01 - US-012
- What was implemented: Redesigned LoginPage with dark design tokens — solid `var(--bg-base)` background, `var(--bg-surface)` card with `var(--border)` border, music note + wordmark logo, `var(--accent)` login button, token-coloured error banner
- Files changed:
  - dashboard/src/pages/LoginPage.tsx: replaced gradient background with `var(--bg-base)`; card uses `var(--bg-surface)` + `var(--border)`; added MusicNoteIcon + logoText wordmark; changed login button to `var(--accent)`; renamed `error` style to `errorBanner` for clarity; updated subtitle and title to use token colours
- **Learnings for future iterations:**
  - LoginPage uses no AppShell — it's a standalone full-page layout with its own container centering via flexbox
  - Error banner uses semi-transparent red (rgba) background/border rather than a token since there's no error token defined
---
