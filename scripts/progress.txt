## Codebase Patterns
- Python tests use stubs in tests/conftest.py (aiohttp.web, jwt) — never need real aiohttp/PyJWT in tests
- pytest is not installed; use: PYTHONPATH=/tmp/pypackages:/workspace python3.11 -m pytest tests/ -v
  (first download pip: curl -sL https://bootstrap.pypa.io/pip/pip.pyz -o /tmp/pip.pyz && python3.11 /tmp/pip.pyz install pytest --target /tmp/pypackages)
- Bot guilds accessed via request.app["bot"].guilds; each guild has .id (int), .name (str), .icon (str|None)
- Elapsed time tracking: Music cog uses `_started_at: dict[int, float|None]` and `_elapsed_offset: dict[int, float]`; API handlers must update these when pausing/resuming/stopping (not just the cog commands)
- When changing API response shapes that TypeScript callers consume, always update both api.ts interfaces AND all .tsx components using them
- Guild IDs are integers on Discord objects but must be serialised as strings in JSON
- JWT middleware auto-protects all routes not starting with /auth/; new API routes are auto-protected
- TypeScript typecheck: cd /workspace/dashboard && npm run typecheck
- New API modules follow pattern: handle_X_get() function + setup_X_routes(app) function

# Ralph Progress Log
Started: Sat Feb 28 16:27:50 PST 2026
---

## 2026-02-28 - US-001
- What was implemented: Added GET /api/guilds endpoint that returns guilds the bot is in
- Files changed:
  - bot/api/guilds.py (new): handle_guilds_get() and setup_guilds_routes()
  - bot/api/server.py: registered guilds routes via setup_guilds_routes()
  - dashboard/src/api.ts: added Guild interface and fetchGuilds() function
  - tests/test_guilds_api.py (new): 7 tests covering happy path, empty states, icon=None, string IDs
  - scripts/prd.json (new): created prd.json for new PRD
- **Learnings for future iterations:**
  - pytest is not installed; install to /tmp/pypackages and set PYTHONPATH (see Codebase Patterns above)
  - The mock_web.Response fake in conftest.py stores text as a string attribute; json.loads(resp.text) is the way to inspect responses
  - bot.guilds list has guild objects with .id (int), .name, .icon attributes; id must be str() in JSON
---

## 2026-02-28 - US-002
- What was implemented: Added `thumbnail: str` field to AudioTrack dataclass and surfaced it in all API responses
- Files changed:
  - bot/audio/resolver.py: added `thumbnail: str = ""` to AudioTrack dataclass; _make_track() now reads info.get("thumbnail", "")
  - bot/api/player.py: _track_dict() now includes "thumbnail" key
  - dashboard/src/api.ts: Track interface gains `thumbnail: string`
  - tests/unit/test_resolver.py: updated _youtube_info() helper to include thumbnail; added 5 new tests
  - tests/test_player_api.py: updated _make_track() helper to set track.thumbnail; fixed exact-equality assertion
- **Learnings for future iterations:**
  - AudioTrack dataclass uses default field values (thumbnail: str = "") — new optional fields can be added at end without breaking existing instantiations
  - _make_track() in test_player_api.py uses MagicMock; any attribute accessed in _track_dict() must be explicitly set or it returns an un-serialisable MagicMock
  - Exact dict equality assertions (assert data["x"] == {...}) must be updated when _track_dict() gains new keys
---

## 2026-02-28 - US-003
- What was implemented: Added `elapsed_seconds: float | None` to /api/playback response; Music cog tracks playback start time and accumulated offset
- Files changed:
  - bot/cogs/music.py: added `import time`, `_started_at` and `_elapsed_offset` dicts; updated `_play_next`, `pause`, `resume`, `stop` commands to maintain timing state
  - bot/api/player.py: `handle_playback_get` computes elapsed_seconds from cog timing; `handle_playback_pause/resume/stop` also update cog timing dicts
  - dashboard/src/api.ts: added `PlaybackData` interface; `fetchPlayback` now returns `Promise<PlaybackData>` with `{ state, elapsedSeconds }`
  - dashboard/src/components/PlaybackControls.tsx: updated `loadState` callback to extract `data.state` from new return type
  - tests/test_player_api.py: added `_started_at = {}` and `_elapsed_offset = {}` to `_make_music_cog`; updated existing playback tests; added 6 new tests for timing behaviour
- **Learnings for future iterations:**
  - Elapsed time uses two dicts: `_started_at` (unix timestamp of current play session start, None when paused/stopped) and `_elapsed_offset` (accumulated seconds from previous sessions)
  - Both the Discord cog commands AND the API handlers must update these timing dicts — the API handlers call vm methods directly, bypassing cog command methods
  - When API response shapes change (e.g. fetchPlayback now returns object not string), all TSX consumers must be updated too
  - `_make_music_cog()` in tests must explicitly initialise any dict attributes (`_started_at`, `_elapsed_offset`) the API handlers access; MagicMock auto-creates attributes that are un-serialisable
---
